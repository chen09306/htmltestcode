<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>多功能聊天系統</title>
<style>
body {
    font-family: "微軟正黑體", sans-serif;
    max-width: 1000px;
    margin: 40px auto;
}

/* 標題 */
h1 {
    text-align: center;
    margin-bottom: 10px;
}

/* 功能按鈕 */
#function-bar {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
}
#function-bar button {
    padding: 12px 100px;
    font-size: 16px;
    border-radius: 6px;
    border: 1px solid #aaa;
    background: #f5f5f5;
    cursor: pointer;
    transition: 0.2s;
}
#function-bar button:hover { background: #e0e0e0; }
#function-bar button:active { transform: scale(0.96); }
#function-bar .active {
    background: #007bff;
    color: white;
    border-color: #007bff;
    font-weight: bold;
}

/* 主區域：對話框 + KB */
#main-area {
    display: flex;
    gap: 10px;
    height: 500px;          /* 原本高度 */
    margin-bottom: 20px;    /* 新增底部間距，避免覆蓋輸入框 */
}

/* 對話框 */
#chat-box {
    flex: 3;
    border: 1px solid #ccc;
    padding: 10px;
    height: 500px;
    overflow-y: auto;
    background-color: #f9f9f9;
    border-radius: 10px;
}
.message {
    margin: 10px 0;
    padding: 10px;
    border-radius: 10px;
    max-width: 70%;
    word-wrap: break-word;
}
.user { background-color: #d1e7ff; margin-left: auto; text-align: right; }
.bot { background-color: #e2f0d9; margin-right: auto; text-align: left; }

/* KB 右側框，隨聊天框高度自適應 */
#kb-box {
    flex: 1;
    border-left: 5px solid #ffb300;
    border-radius: 5px;
    padding: 10px;
    background: #fff9e6;
    overflow-y: auto;
    display: none;
}

/* 下方輸入區 */
#input-area {
    margin-top: 30px;
    display: flex;
    gap: 5px;
}
textarea, input, select {
    flex: 1;
    padding: 10px;
    font-size: 16px;
    margin-right: 5px;
    border-radius: 6px;
    border: 1px solid #ccc;
}
button { padding: 10px 15px; font-size: 16px; cursor: pointer; border-radius: 6px; }

/* 讓主區域跟 KB 高度同步 */
#main-area { height: 500px; }
#chat-box, #kb-box { height: 100%; }
</style>
</head>
<body>

<h1 id="system-title">金融問答聊天系統</h1>

<!-- 功能按鈕 -->
<div id="function-bar">
    <button class="active" onclick="switchSystem(1)">金融問答</button>
    <button onclick="switchSystem(2)">新聞摘要</button>
    <button onclick="switchSystem(3)">資產配置</button>
</div>

<!-- 主區域：聊天框 + KB -->
<div id="main-area">
    <div id="chat-box"></div>
    <div id="kb-box"></div>
</div>

<!-- 輸入區 -->
<div id="input-area"></div>

<script>
let BASE_URL = "https://odelia-apetalous-nonmutably.ngrok-free.dev"; // ← 固定後端 URL
let currentFunction = 1;
const chatBox = document.getElementById("chat-box");
const kbBox = document.getElementById("kb-box");
const inputArea = document.getElementById("input-area");

/* ======================== 建立輸入框 ======================== */
function createDefaultInput() {
    inputArea.innerHTML = `
        <textarea id="question" placeholder="請輸入你的問題..." rows="2"></textarea>
        <button onclick="askQuestion()">送出</button>
        <button onclick="clearChat()">清除對話</button>
    `;
    const questionInput = document.getElementById("question");
    questionInput.addEventListener("keydown", e => {
        if(e.key === "Enter" && !e.shiftKey){
            e.preventDefault();
            askQuestion();
        }
    });
}

function createnewsInput() {
    inputArea.innerHTML = `
        <textarea id="question" placeholder="請輸入你的新聞網址..." rows="2"></textarea>
        <button onclick="askQuestion()">送出</button>
        <button onclick="clearChat()">清除對話</button>
    `;
    const questionInput = document.getElementById("question");
    questionInput.addEventListener("keydown", e => {
        if(e.key === "Enter" && !e.shiftKey){
            e.preventDefault();
            askQuestion();
        }
    });
}

function createAssetInput() {
    inputArea.innerHTML = `
        <input type="number" id="age" placeholder="年齡 (與風險偏好擇一填入)">
        <select id="risk">
            <option value="">風險偏好 (與年齡擇一填入)</option>
            <option value="高">高</option>
            <option value="中">中</option>
            <option value="低">低</option>
        </select>
        <input type="number" id="amount" placeholder="投資金額 (必填)">
        <button onclick="askQuestion()">送出</button>
        <button onclick="clearChat()">清除對話</button>
    `;
    const amountInput = document.getElementById("amount");
    amountInput.addEventListener("keydown", e => {
        if(e.key === "Enter"){
            e.preventDefault();
            askQuestion();
        }
    });
}

/* ======================== 顯示訊息 ======================== */
function appendMessage(role, text) {
    const div = document.createElement("div");
    div.className = "message " + role;
    div.innerHTML = text;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function clearChat() {
    chatBox.innerHTML = "";
    kbBox.innerHTML = "";
}

/* ======================== 切換功能 ======================== */
function switchSystem(n) {
    currentFunction = n;

    document.querySelectorAll("#function-bar button").forEach(btn => btn.classList.remove("active"));
    document.querySelector(`#function-bar button:nth-child(${n})`).classList.add("active");

    clearChat();

    if(n === 1) createDefaultInput();
    else if(n === 2) createnewsInput();
    else createAssetInput();

    // KB 只在功能 1 顯示
    kbBox.style.display = n === 1 ? "block" : "none";

    const titles = ["金融問答聊天系統", "新聞摘要系統", "資產配置系統"];
    document.getElementById("system-title").innerText = titles[n - 1];
}

/* ======================== 送出問題 ======================== */
async function askQuestion() {
    let endpoint = "";
    let payload = {};

    if(currentFunction === 1) {
        const q = document.getElementById("question").value.trim();
        if(!q) return;
        appendMessage("user", q);
        payload = { question: q, separate: true };
        endpoint = `${BASE_URL}/ask`;
        document.getElementById("question").value = "";

    } else if(currentFunction === 2) {
        const q = document.getElementById("question").value.trim();
        if(!q) return;
        appendMessage("user", q);
        payload = { question: q };
        endpoint = `${BASE_URL}/news`;
        document.getElementById("question").value = "";

    } else {
        const age = document.getElementById("age").value || null;
        const risk = document.getElementById("risk").value || null;
        const amount = document.getElementById("amount").value;
        if(!amount) return alert("請輸入金額");
        appendMessage("user", `年齡:${age || "未填"}, 風險:${risk || "未填"}, 金額:${amount}`);
        payload = { age, risk_level: risk, amount };
        endpoint = `${BASE_URL}/asset`;
        document.getElementById("amount").value = "";
    }

    try {
        const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        const data = await res.json();

        appendMessage("bot", data.answer);

        // KB 只在功能 1 顯示
        if(currentFunction === 1 && data.knowledge) {
            kbBox.innerHTML = data.knowledge;
        }

    } catch(err) {
        appendMessage("bot", "伺服器出錯，請稍後再試");
        console.error(err);
    }
}

window.onload = () => {
    createDefaultInput();
    kbBox.style.display = "block"; // 初始顯示 KB
};
</script>

</body>
</html>

